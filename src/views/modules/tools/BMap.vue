<template>
  <div class='console'>
    <!--百度地图容器-->
    <div style='width:100%;height:800px;border:#ccc solid 1px;' id='mapContent'></div>
    <el-dialog :title='title'   v-dialogDrag :visible.sync='dialogTableVisible'>
      <img width="500px" v-if="index === 1" height="300px" src="~@/assets/img/zjs.png" />
      <img width="500px" v-if="index === 2" height="300px" src="~@/assets/img/xwh.png" />
    </el-dialog>
  </div>
</template>
<script>
// 引入富文本编辑器所需样式
export default {
  data () {
    return {
      ak: 'tLX80GGQGgv4KAMGv71TqeffeKDPSKGD', // 正式线上项目，务必替换成自己的key
      dialogTableVisible: false,
      BMap: null,
      map: null,
      title: '',
      imgUrl: '',
      index: 1,
      pointStr: '113.51218508760768,23.647429192600182;' +
        '113.51187966373439,23.64772712149375;' +
        '113.51162813819167,23.64785953411512;' +
        '113.51137661264896,23.647925740374976;' +
        '113.51114305321644,23.6481574620177;' +
        '113.51035254436793,23.648091255876416;' +
        '113.5101549171558,23.64797539504764;' +
        '113.50972373051115,23.647694018317235;' +
        '113.50952610329902,23.64772712149375;' +
        '113.50893322166263,23.647842982544866;' +
        '113.5087355944505,23.64785953411512;' +
        '113.50823254336508,23.647611260338888;' +
        '113.50808881448353,23.647644363536582;' +
        '113.5070467800923,23.64678367764387;' +
        '113.5067772884394,23.64646919483177;' +
        '113.50656169511707,23.646121607676452;' +
        '113.50611254236223,23.645608501121508;' +
        '113.50605864403165,23.645442982443914;' +
        '113.50629220346417,23.644913321252776;' +
        '113.50622033902339,23.644185033574807;' +
        '113.50627423735398,23.643986408951235;' +
        '113.50605864403165,23.64410227335204;' +
        '113.50586101681952,23.644069169248116;' +
        '113.50557355905643,23.643820888198686;' +
        '113.5059149151501,23.64342363752875;' +
        '113.50580711848895,23.64325811605635;' +
        '113.50571728793797,23.643142250899693;' +
        '113.50528610129332,23.643373981109264;' +
        '113.50516033852197,23.64332432467072;' +
        '113.50508847408119,23.643109146550167;' +
        '113.50469321965693,23.642612580291004;' +
        '113.50481898242829,23.642397400986955;' +
        '113.505070507971,23.642165669028607;' +
        '113.505627457387,23.642149116729993;' +
        '113.5062023729132,23.64190083199667;' +
        '113.5065077967865,23.64163599442275;' +
        '113.50686711899036,23.64155323256976;' +
        '113.50656169511707,23.6414539182763;' +
        '113.50614847458262,23.641420813494875;' +
        '113.50589694903991,23.6414539182763;' +
        '113.50559152516662,23.641404261100988;' +
        '113.50553762683603,23.64203325058039;' +
        '113.5047830502079,23.641884279664175;' +
        '113.50496271130984,23.641685651509142;' +
        '113.50498067742004,23.641122870080995;' +
        '113.50521423685255,23.64110631764899;' +
        '113.50519627074236,23.640824925981185;' +
        '113.50469321965693,23.640758716088072;' +
        '113.50492677908946,23.64026214081009;' +
        '113.50526813518313,23.64052698119545;' +
        '113.50544779628507,23.64009661529402;' +
        '113.50571728793797,23.64024558826801;' +
        '113.50611254236223,23.64026214081009;' +
        '113.50640000012532,23.6400635101654;' +
        '113.50672339010882,23.639947642148563;' +
        '113.50683118676997,23.639798668831627;' +
        '113.50726237341462,23.639798668831627;' +
        '113.507298305635,23.639997299882765;' +
        '113.50715457675346,23.64008006273077;' +
        '113.50728033952481,23.640328350957233;' +
        '113.50717254286366,23.64052698119545;' +
        '113.50690305121076,23.64079182103886;' +
        '113.50611254236223,23.64100700301257;' +
        '113.50595084737049,23.64100700301257;' +
        '113.50580711848895,23.64110631764899;' +
        '113.50580711848895,23.6411890797878;' +
        '113.50695694954133,23.64150357543255;' +
        '113.50742406840637,23.641321499099796;' +
        '113.50790915338159,23.640940793212614;' +
        '113.5081606789243,23.64052698119545;' +
        '113.50823254336508,23.640593191207113;' +
        '113.50772949227965,23.64127184187367;' +
        '113.50728033952481,23.6414539182763;' +
        '113.50695694954133,23.641586337317303;' +
        '113.50690305121076,23.641867727329572;' +
        '113.50728033952481,23.641933936655303;' +
        '113.50767559394907,23.642281535059652;' +
        '113.50798101782237,23.642562923560288;' +
        '113.50790915338159,23.6413049466932;' +
        '113.50866373000973,23.64133805150426;' +
        '113.50877152667088,23.64156978494459;' +
        '113.50830440780585,23.64219877361949;' +
        '113.50884339111167,23.64272844592191;' +
        '113.50920271331553,23.642678789235653;' +
        '113.50925661164611,23.642397400986955;' +
        '113.50932847608689,23.642331191898347;' +
        '113.50956203551941,23.64238084871798;' +
        '113.50966983218056,23.64252981906256;' +
        '113.50983152717231,23.64248016230009;' +
        '113.50993932383348,23.642513266810518;' +
        '113.50992135772329,23.64274499814643;' +
        '113.50993932383348,23.643059490009996;' +
        '113.50977762884173,23.64325811605635;' +
        '113.50945423885824,23.64332432467072;' +
        '113.50927457775632,23.643605710903852;' +
        '113.50877152667088,23.643638815126348;' +
        '113.50896915388302,23.644185033574807;' +
        '113.50866373000973,23.64464848984415;' +
        '113.50843017057721,23.644979529020233;' +
        '113.50772949227965,23.64501263289127;' +
        '113.50708271231268,23.644880217356338;' +
        '113.50693898343114,23.644996080956812;' +
        '113.50722644119423,23.644996080956812;' +
        '113.50758576339811,23.64512849637316;' +
        '113.50808881448353,23.645145048290686;' +
        '113.50843017057721,23.645277463554596;' +
        '113.50877152667088,23.645476086196375;' +
        '113.50895118777282,23.645856778740892;' +
        '113.50884339111167,23.64607195229232;' +
        '113.50884339111167,23.646419539581036;' +
        '113.50902305221359,23.64646919483177;' +
        '113.50914881498495,23.646419539581036;' +
        '113.50902305221359,23.646138159466926;' +
        '113.50911288276457,23.645906434207596;' +
        '113.50936440830728,23.645956089655247;' +
        '113.50916678109515,23.64537677491359;' +
        '113.50954406940922,23.64540987868299;' +
        '113.50983152717231,23.645062288681927;' +
        '113.51022678159657,23.644929873197814;' +
        '113.5104244088087,23.64494642514074;' +
        '113.51064000213103,23.64531056734939;' +
        '113.51123288376742,23.64529401545305;' +
        '113.51146644319994,23.645178152119364;' +
        '113.51164610430187,23.6448305614958;' +
        '113.51189762984458,23.64464848984415;' +
        '113.51202339261593,23.644615385879963;' +
        '113.51232881648923,23.64466504182307;' +
        '113.51256237592175,23.644615385879963;' +
        '113.51272407091348,23.64466504182307;' +
        '113.51283186757465,23.6445657299178;' +
        '113.51274203702368,23.644449865931975;' +
        '113.51286779979503,23.6443836578935;' +
        '113.51319118977852,23.64464848984415;' +
        '113.51322712199891,23.64481400953806;' +
        '113.51319118977852,23.644896769305618;' +
        '113.51333491866006,23.64532711924362;' +
        '113.51329898643968,23.64557539740293;' +
        '113.51340678310085,23.645625052977625;' +
        '113.5132630542193,23.6456912603809;' +
        '113.5126701725829,23.64656850527606;' +
        '113.51245457926058,23.646916091230796;' +
        '113.51270610480329,23.647065056354126;' +
        '113.51261627425232,23.647214021305928;' +
        '113.51245457926058,23.647164366341055;' +
        '113.51238271481981,23.647462295844456;' +
        '113.51218508760768,23.647346434452427;' +
        '113.51216712149748,23.647445744223376;' +
        '113.51187966373439,23.64772712149375;' +
        '113.51218508760768,23.647429192600182'
    }
  },
  mounted () {
    this.initMap()
  },
  methods: {
    initMap () {
      // eslint-disable-next-line no-undef
      var bmap = new BMapGL.Map('mapContent')    // 创建Map实例
      // eslint-disable-next-line no-undef
      bmap.centerAndZoom(new BMapGL.Point(113.506135, 23.642296), 17)  // 初始化地图,设置中心点坐标和地图级别
      bmap.enableScrollWheelZoom(true)     // 开启鼠标滚轮缩放
      bmap.setTilt(20)
      this.map = bmap
      // 获取区域
      this.getBoundaryNy()
      // 获取轨迹
      this.getGuJi()
      // 3d轨迹动画
      // this.getGuiJi3d()
    },
    getBoundaryNy () {
      // 思路：利用行政区划点的集合与外围自定义东南西北形成一个环形遮罩层
      // 清除地图覆盖物
      this.map.clearOverlays()
      // 自定义外围边框点的集合
      // 东北角
      var EN_JW = '180, 90;'
      // 西北角
      var NW_JW = '-180, 90;'
      // 西南角
      var WS_JW = '-180, -90;'
      // 东南角
      var SE_JW = '180, -90;'
      var pointStrArr = this.pointStr.split(';')
      var pointArray = []
      if (pointStrArr.length > 0) {
        for (var i = 0; i < pointStrArr.length; i++) {
          // eslint-disable-next-line no-undef
          var point = new BMapGL.Point(pointStrArr[i].split(',')[0], pointStrArr[i].split(',')[1])
          pointArray.push(point)
        }
      }
      // eslint-disable-next-line no-undef
      var polygon1 = new BMapGL.Polygon(pointArray + SE_JW + SE_JW + WS_JW + NW_JW + EN_JW + SE_JW, {strokeColor: 'none', strokeOpacity: 0, fillColor: '#00031A', fillOpacity: '0.9'})
      // eslint-disable-next-line no-undef
      var polygon2 = new BMapGL.Polygon(pointArray, {strokeColor: 'blue', strokeWeight: 2, strokeOpacity: 0.5})
      this.map.addOverlay(polygon1)
      this.map.addOverlay(polygon2)
      // 添加各区域
      this.$http({
        url: '/baseinfo/baseregion/baseRegion/homeTreeData',
        method: 'get'
      }).then(({data}) => {
        if (data && data.success) {
          if (data.regionList !== null && data.regionList.length > 0) {
            // 添加划分出来的各个具体区域
            for (var i = 0; i < data.regionList.length; i++) {
              // 区域设置坐标时地图上添加各区域
              if (data.regionList[i].posXy) {
                var pointStrArr = data.regionList[i].posXy.substring(0, data.regionList[i].posXy.length - 1).split(';')
                var pointArray = []
                if (pointStrArr.length > 0) {
                  for (var j = 0; j < pointStrArr.length; j++) {
                    // eslint-disable-next-line no-undef
                    var point = new BMapGL.Point(pointStrArr[j].split(',')[0], pointStrArr[j].split(',')[1])
                    pointArray.push(point)
                  }
                }
                // eslint-disable-next-line no-undef
                var plyArea = new BMapGL.Polygon(pointArray, {strokeWeight: 1, strokeColor: 'yellow', fillColor: '', fillOpacity: '0.5'})
                this.map.addOverlay(plyArea)
              }
            }
          }
          // 获取设备列表并添加标注
          // this.getEquipmentList()
        }
      })
    },
    getGuJi () {
      var path = [{
        'lng': 113.49853533538807,
        'lat': 23.646831263792272
      }, {
        'lng': 113.51096788364205,
        'lat': 23.646831263792272
      }, {
        'lng': 113.51096788364205,
        'lat': 23.636767438407368
      }, {
        'lng': 113.49853533538807,
        'lat': 23.636767438407368
      }]
      var point = []
      for (var i = 0; i < path.length; i++) {
        // eslint-disable-next-line no-undef
        point.push(new BMapGL.Point(path[i].lng, path[i].lat))
      }
      // eslint-disable-next-line no-undef
      var pl = new BMapGL.Polyline(point)
      // eslint-disable-next-line no-undef
      var trackAni = new BMapGLLib.TrackAnimation(this.map, pl, {
        overallView: true,
        tilt: 60,
        duration: 20000,
        delay: 3000,
        zoom: 15
      })
      // 开始播放动画
      setTimeout(() => {
        trackAni.start()
      }, 2000)
    },
    getGuiJi3d () {
      var keyFrames = [
        {
          // eslint-disable-next-line no-undef
          center: new BMapGL.Point(113.49853533538807, 23.646831263792272),
          zoom: 17,
          tilt: 60,
          heading: 0,
          percentage: 0
        },
        {
          // eslint-disable-next-line no-undef
          center: new BMapGL.Point(113.51096788364205, 23.646831263792272),
          zoom: 17,
          tilt: 50,
          heading: 0,
          percentage: 0.75
        },
        {
          // eslint-disable-next-line no-undef
          center: new BMapGL.Point(113.51096788364205, 23.636767438407368),
          zoom: 17,
          tilt: 60,
          heading: 90,
          percentage: 0.85
        },
        {
          // eslint-disable-next-line no-undef
          center: new BMapGL.Point(113.49853533538807, 23.636767438407368),
          zoom: 17,
          tilt: 50,
          heading: 0,
          percentage: 1
        }
      ]

      var opts = {
        duration: 10000,
        delay: 2,
        interation: 'INFINITE'
      }

      // 声明动画对象
      // eslint-disable-next-line no-undef
      var animation = new BMapGL.ViewAnimation(keyFrames, opts)
      // 监听事件
      animation.addEventListener('animationstart', function (e) {
        console.log('start')
      })
      animation.addEventListener('animationiterations', function (e) {
        console.log('onanimationiterations')
      })
      animation.addEventListener('animationend', function (e) {
        console.log('end')
      })
      // 开始播放动画
      setTimeout(() => {
        this.map.startViewAnimation(animation)
      }, 1000)
    }
  }
}
</script>

<style lang='scss' scoped>
.article-box {
  width: 100%;
  .el-pagination {
    margin-top: 20px;
  }
  .quill-editor {
    height: 300px;
    margin-bottom: 20px;
  }
}
</style>
